services:
  # 1. A Render-Managed Redis Instance
  - type: redis
    name: redis
    plan: free
    # âœ… FINAL FIX: The ipAllowList contains a list of objects.
    # The 'source' key is removed, and 'type' and 'name' are the keys of each list item.
    ipAllowList:
      - type: service
        name: api
      - type: service
        name: worker

  # 2. The FastAPI Web Service (using Docker)
  - type: web
    name: api
    env: docker
    plan: free
    dockerfilePath: ./Dockerfile
    # The Dockerfile's default CMD will correctly start the uvicorn server.
    envVars:
      - key: PORT # Render requires this for web services
        value: 5000
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: redis
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: redis
          property: connectionString
      - key: USE_BROWSER_COOKIES
        value: false # No browser in the container
      - key: WHISPER_THREADS
        value: 1 # Stay within the 512MB RAM limit
      - key: MAX_CONCURRENT
        value: 4
      - key: CLIENT_ORIGIN
        value: "https://your-frontend-url.onrender.com" # Placeholder

  # 3. The Celery Worker & Beat (using Docker)
  - type: worker
    name: worker
    env: docker
    plan: free
    dockerfilePath: ./Dockerfile
    # Use 'dockerCommand' to override the Dockerfile's CMD and run worker+beat.
    dockerCommand: >
      celery -A celery_app.celery_app worker -l info --concurrency=4 -B --scheduler celery.beat.PersistentScheduler --schedule-filename /tmp/celerybeat-schedule
    envVars:
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: redis
          property: connectionString
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: redis
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: redis
          property: connectionString
      - key: USE_BROWSER_COOKIES
        value: false
      - key: WHISPER_THREADS
        value: 1
      - key: MAX_CONCURRENT
        value: 4
